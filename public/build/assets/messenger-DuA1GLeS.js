var m=0;const T=$(".message-form"),k=$(".wsus__user_list_area_height"),S=$(".message-input"),r=$(".wsus__chat_area_body"),i=$("meta[name=csrf_token]").attr("content"),l=()=>$("meta[name=id]").attr("content"),D=t=>$("meta[name=id]").attr("content",t);function h(t,e){if(t.files&&t.files[0]){var s=new FileReader;s.onload=function(o){$(e).attr("src",o.target.result)},s.readAsDataURL(t.files[0])}}function I(){$(".wsus__message_paceholder").addClass("d-none")}function M(){$(".wsus__chat_app").removeClass("show_info"),$(".wsus__message_paceholder").removeClass("d-none")}function B(){$(".wsus__message_paceholder.black").addClass("d-none")}let c=1,u=!1,p="";function _(t){t!=p&&(c=1,u=!1),p=t,u||$.ajax({method:"GET",url:"messenger/search",data:{query:t,page:c},beforeSend:function(){$(".user_search_list_result").append(`<div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>`)},success:function(e){console.log(e.records),c<2?$(".user_search_list_result").html(e.records):$(".user_search_list_result").append(e.records),u=c>=(e==null?void 0:e.last_page),u||c++},error:function(e,s,o){console.log(e),console.log(o),console.log(s)}})}function v(t,e,s=!1){$(t).on("scroll",function(){let o=$(this).get(0);o.style.maxHeight="750px",(s?o.scrollTop==0:o.scrollTop+o.clientHeight>=o.scrollHeight)&&e()})}const j=(t,e)=>{let s;return(...o)=>{clearTimeout(s),s=setTimeout(()=>{t.apply(null,o)},e)}};function E(t){$.ajax({method:"GET",url:"messenger/id-info",data:{id:t},beforeSend:function(){NProgress.start(),M()},success:function(e){x(e.record.id,!0),e.contents?($(".nothing_share").addClass("d-none"),$(".shared-photo-gallery").html(e.contents)):($(".nothing_share").removeClass("d-none"),$(".shared-photo-gallery").html("")),e.favorite?$(".favourite").addClass("active"):$(".favourite").removeClass("active"),$(".messenger-header").find("img").attr("src",e.record.avatar),$(".messenger-header").find("h4").text(e.record.name),$(".messenger-info-view .user_photo").find("img").attr("src",e.record.avatar),$(".messenger-info-view").find(".user_name").text(e.record.name),NProgress.done(),I(),B()},error:function(e,s,o){console.log(e)}})}function H(t){m++;let e=!!$(".attachment-input").val(),s=`temp_${m}`;if(S.val().length>0||e){const n=new FormData($(".message-form")[0]);n.append("id",l()),n.append("temporaryMsgId",s),n.append("_token",i),$.ajax({method:"POST",url:"/messenger/send-message",data:n,dataType:"JSON",processData:!1,contentType:!1,beforeSend:function(){$(".emojionearea-editor").text("")},success:function(f){const g=$(`.wsus__single_chat[data-id="${s}"]`);console.log(g),g.closest(".wsus__single_chat_area").remove(),r.append(f.message),w(),b(r),y()},error:function(f,g,C){console.log(f),console.log(C)}})}}function w(){$(".attachment-block").addClass("d-none"),T.trigger("reset"),console.log("working")}let a=1,d=!1;function x(t,e=!1){e&&(a=1,d=!1),d||$.ajax({method:"GET",url:"messenger/fetch-message",data:{_token:i,id:t,page:a},beforeSend:function(){r.prepend(`
                
                <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                       `)},success:function(s){P(),a===1?(r.html(s.messages),b(r)):r.prepend(s.messages),d=a>=(s==null?void 0:s.last_page),!d&&a<=(s==null?void 0:s.last_page)&&a++},error:function(s,o,n){console.log(s),console.log(o),console.log(n)}})}function P(t){const e=$(`.messenger-list_item[data-id="${l()}]`);$(`.messenger-list-item[data-id="${l()}"]`).find(".unseen_count").remove(),console.log(e),$.ajax({method:"GET",url:"messenger/make-seen",data:{_token:i,id:l()},success:function(s){console.log(s)},error:function(s,o,n){console.log(s)}})}function L(t){$(".favourite").toggleClass("active"),$.ajax({method:"POST",url:"messenger/favorite",data:{_token:i,id:t},success:function(e){console.log(e.status),e.status=="added"?notyf.success("Added to favorites list."):notyf.success("Removed favorites list.")},error:function(e,s,o){console.log(e)}})}function b(t){$(t).stop().animate({scrollTop:$(t)[0].scrollHeight}),console.log("scroll")}let G=1;function y(){$.ajax({method:"GET",url:"messenger/fetch-contacts",data:{page:G},beforeSend:function(){},success:function(t){console.log(t),k.html(t.contacts)},error:function(t,e,s){console.log(t,s)}})}function A(t){Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete it!"}).then(e=>{e.isConfirmed&&$.ajax({method:"DELETE",url:"messenger/delete-message",data:{_token:i,message_id:t},success:function(s){Swal.fire({title:"Deleted!",text:"Your file has been deleted.",icon:"success"}),$(`.message-card[data-id="${t}"]`).remove()},error:function(s,o,n){console.log(s,o,n)}})})}$(document).ready(function(){y(),$("#select_file").change(function(){h(this,".profile-image-preview")});const t=j(function(){const e=$(".user-search").val();_(e)},500);$(".user-search").on("keyup",function(e){e.preventDefault();let s=$(".user_search_list_result").get(0);s.style.maxHeight="750px",$(this).val().length>0&&t()}),$(".user-search").get(0).style.maxHeight="750px",v(".user_search_list_result",function(){let e=$(".user_search").val();_(e)}),$("body").on("click",".messenger-list-item",function(){const e=$(this).attr("data-id");D(e),E(e)}),$(".message-form").on("submit",function(e){e.preventDefault(),H()}),$(".attachment-input").change(function(){h(this,".attachment-preview"),$(".attachment-block").removeClass("d-none")}),$(".cancel-attachment").on("click",function(){w()}),v(".wsus__chat_area_body",function(){x(l())},!0),$(".favourite").on("click",function(e){e.preventDefault(),L(l())}),$("body").on("click",".dlt-message",function(e){e.preventDefault();let s=$(this).data("id");A(s),console.log(this)})});
